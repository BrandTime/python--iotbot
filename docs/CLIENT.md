# 客户端(IOTBOT)

## 初始化

```python
from iotbot import IOTBOT

bot = IOTBOT(123456)
```

参数:

- qq: 机器人 QQ 号(必选), **如需支持多Q，则传入QQ号列表，但是不建议，多Q某些功能可能表现不太好**
- use_plugins: 是否开启插件功能
- plugin_dir: 插件存放目录
- group_blacklist: 群黑名单, 此名单中的群聊消息不会被处理,默认为空，即全部处理
- friend_whitelist: 好友白名单，只有此名单中的好友消息才会被处理，默认为空，即全部处理
- log: 是否开启 log
- log_file_path: 日志文件路径
- port: 运行端口
- beat_delay: 心跳延时时间（s）
- host: ip，需要包含协议

到时候用的时候，IDE 或编辑器会提示的，没什么好讲的地方。。。

## 注册接收函数

在收到服务端消息后，会将消息作为参数传入每个消息接受函数(receiver)自动执行

### 通过方法添加接收函数

- bot.add_group_msg_receiver(func) # 群消息
- bot.add_friend_msg_receiver(func) # 好友消息
- bot.add_event_receiver(func) # 事件消息

func 是对应的接收函数

### 通过装饰器添加接收函数

- @bot.on_group_msg # 群消息
- @bot.on_friend_msg # 好友消息
- @bot.on_event # 事件消息

装饰器本质是调用的方法。

**接收函数数量为 0 个或无限多个, 函数名也随意**

## 消息上下文

接收函数必须有且只有一个参数，这个参数是消息上下文(后面用 ctx 代替)，是将服务端传入信息处理后的对象。
原始数据是一个字典, ctx 的各项属性是原始数据的**固定字段**，其中 ctx.message 即是原始数据。

注意事件消息 ctx 还是原始字典。(具体用的时候，打印出来分析即可)

建议导入相关类(FriendMsg, GroupMsg)，使用注解语法，这样可以获得足够的代码提示

**事件类型现已不是字典，跟群消息好友消息一样是处理后的对象**

## 消息中间件

可以对每一个(三个)消息上下文注册且只能一个中间件函数，中间件函数要求接收一个参数(与接收函数一样),
**中间件的返回值将作为每个消息接收函数的参数**, 建议只在原始对象上添加属性，而不修改或返回其他类型的值

## 提取准确信息的 refine 函数

默认传递的上下文对象只包含该消息的固定字段，也就是不管哪种，都会包含的东东。
一般情况下，对于群消息和好友消息的接收是够了的，但是有时候需要提取图片数据，语音，或者红包数据时，
会有很多不同的字段，需要自己解码 json。同样，对于群和好友消息来说这都还好，但是对于**事件**消息,
有很多不同的字段，如果要做这方面的功能，会比较麻烦。

所以提供了一系列 `refine_?` 函数用来进一步解析数据。

每一种消息类型对应一个函数，如果该消息类型与该函数应该处理的类型一致，则会返回一个新的对象，
其中包含该信息类型的特有字段，否则返回空值。（所以，refine 函数也能起判断(类型筛选)的作用）

说得有点绕，详情看示例: [bot_test_refine_funcs.py](https://github.com/XiyaoWong/python-iotbot/blob/master/sample/plugins/bot_test_refine_funcs.py)

## 客户端属性或方法

- `IOTBOT.receivers` 属性，三种消息接收函数数量
- `IOTBOT.refresh_plugins` 方法, 刷新插件，后面插件部分会讲

---

**注意不要中途修改属性**
